{% extends "base.html" %}

{% block title %}Add Vacation - Vacation Management{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-plus me-2"></i>Add Vacation Period</h2>
    <a href="{{ url_for('my_vacations') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i>Back to Vacations
    </a>
</div>

<div class="row" x-data="vacationForm()">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <form method="POST" @submit="handleSubmit($event)">
                    {% if current_user.is_authenticated %}
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-user me-2"></i>User
                        </label>
                        <div class="form-control-plaintext">
                            <strong>{{ current_user.mail }}</strong>
                        </div>
                        <div class="form-text">Adding vacation for your account.</div>
                    </div>
                    {% endif %}

                    <!-- Validation Error Display -->
                    <div x-show="errorMessage" x-transition class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span x-text="errorMessage"></span>
                    </div>

                    <div class="mb-3">
                        <label for="start_date" class="form-label">
                            <i class="fas fa-calendar-alt me-2"></i>Start Date
                        </label>
                        <input type="date" 
                               name="start_date" 
                               id="start_date" 
                               class="form-control" 
                               :class="{ 'is-invalid': startDateError }"
                               x-model="startDate"
                               :min="todayString"
                               @change="validateDates()"
                               required>
                        <div x-show="startDateError" class="invalid-feedback" x-text="startDateError"></div>
                        <div class="form-text">The first day of the vacation period (today or future).</div>
                    </div>

                    <div class="mb-3">
                        <label for="end_date" class="form-label">
                            <i class="fas fa-calendar-check me-2"></i>End Date
                        </label>
                        <input type="date" 
                               name="end_date" 
                               id="end_date" 
                               class="form-control"
                               :class="{ 'is-invalid': endDateError }"
                               x-model="endDate"
                               :min="startDate || todayString"
                               :disabled="isSingleDay"
                               :style="{ opacity: isSingleDay ? '0.5' : '1' }"
                               @change="validateDates()">
                        <div x-show="endDateError" class="invalid-feedback" x-text="endDateError"></div>
                        <div class="form-text">
                            The last day of the vacation period. Leave empty for a single-day vacation.
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   id="singleDay" 
                                   x-model="isSingleDay"
                                   @change="handleSingleDayToggle()">
                            <label class="form-check-label" for="singleDay">
                                <i class="fas fa-calendar-day me-2"></i>Single day vacation
                            </label>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('my_vacations') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Cancel
                        </a>
                        <button type="submit" 
                                class="btn btn-success" 
                                :disabled="!isFormValid || isSubmitting">
                            <span x-show="!isSubmitting">
                                <i class="fas fa-plus me-1"></i>Add Vacation
                            </span>
                            <span x-show="isSubmitting">
                                <i class="fas fa-spinner fa-spin me-1"></i>Adding...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Dynamic Vacation Summary -->
        <div class="card mb-3" x-show="startDate" x-transition>
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Vacation Summary</h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Start Date:</strong> 
                    <span x-text="formatDate(startDate)"></span>
                </div>
                <div class="mb-2" x-show="endDate && !isSingleDay">
                    <strong>End Date:</strong> 
                    <span x-text="formatDate(endDate)"></span>
                </div>
                <div class="mb-2">
                    <strong>Duration:</strong> 
                    <span x-text="vacationDuration"></span>
                </div>
                <div x-show="isSingleDay" class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>Single day vacation
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-info-circle me-2"></i>Instructions</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Choose the start date
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Optionally set an end date for multi-day vacations
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Leave end date empty for single-day vacations
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Only you can add vacations for your account
                    </li>
                </ul>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-lightbulb me-2"></i>Tips</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-calendar-day text-info me-2"></i>
                        Single-day vacations are useful for sick days or personal days
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-calendar-week text-info me-2"></i>
                        Multi-day vacations are for longer periods like holidays
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-clock text-info me-2"></i>
                        Vacation periods prevent users from being selected as "Catcher of the Day"
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('vacationForm', () => ({
        startDate: '',
        endDate: '',
        isSingleDay: false,
        isSubmitting: false,
        errorMessage: '',
        startDateError: '',
        endDateError: '',
        
        get todayString() {
            return new Date().toISOString().split('T')[0];
        },
        
        get isFormValid() {
            return this.startDate && 
                   !this.startDateError && 
                   !this.endDateError && 
                   !this.errorMessage;
        },
        
        get vacationDuration() {
            if (!this.startDate) return '';
            
            if (this.isSingleDay || !this.endDate) {
                return '1 day';
            }
            
            const start = new Date(this.startDate);
            const end = new Date(this.endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            return `${diffDays} day${diffDays > 1 ? 's' : ''}`;
        },
        
        formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        },
        
        validateDates() {
            this.errorMessage = '';
            this.startDateError = '';
            this.endDateError = '';
            
            // Validate start date
            if (this.startDate && this.startDate < this.todayString) {
                this.startDateError = 'Start date cannot be in the past';
                return;
            }
            
            // Validate end date
            if (this.endDate) {
                if (this.endDate < this.todayString) {
                    this.endDateError = 'End date cannot be in the past';
                    return;
                }
                
                if (this.startDate && this.endDate < this.startDate) {
                    this.endDateError = 'End date cannot be before start date';
                    return;
                }
            }
        },
        
        handleSingleDayToggle() {
            if (this.isSingleDay) {
                this.endDate = '';
                this.endDateError = '';
            }
            this.validateDates();
        },
        
        handleSubmit(event) {
            // Validate before submission
            this.validateDates();
            
            if (!this.isFormValid) {
                event.preventDefault();
                if (!this.errorMessage && !this.startDateError && !this.endDateError) {
                    this.errorMessage = 'Please fill in all required fields correctly';
                }
                return false;
            }
            
            this.isSubmitting = true;
            // Form will submit normally, server will handle the rest
            return true;
        }
    }));
});
</script>
{% endblock %}