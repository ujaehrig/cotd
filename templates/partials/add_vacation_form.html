<div class="card mb-4" x-data="addVacationModal()">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-plus me-2"></i>Add Vacation Period</h5>
        <button type="button" class="btn-close" 
                @click="closeForm()"
                aria-label="Close"></button>
    </div>
    <div class="card-body">
        <form hx-post="{{ url_for('add_vacation') }}"
              hx-target="#vacation-table"
              hx-swap="innerHTML"
              hx-on::after-request="if(event.detail.successful) { closeForm(); }"
              hx-on::response-error="handleFormError(event)"
              @submit="handleSubmit($event)">
            
            <!-- Error message container -->
            <div x-show="errorMessage" x-transition class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span x-text="errorMessage"></span>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="start_date" class="form-label">
                            <i class="fas fa-calendar-alt me-2"></i>Start Date
                        </label>
                        <input type="date" 
                               name="start_date" 
                               id="start_date" 
                               class="form-control"
                               :class="{ 'is-invalid': startDateError }"
                               x-model="startDate"
                               :min="todayString"
                               @change="validateDates()"
                               required>
                        <div x-show="startDateError" class="invalid-feedback" x-text="startDateError"></div>
                        <div class="form-text">The first day of the vacation period (today or future).</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="end_date" class="form-label">
                            <i class="fas fa-calendar-check me-2"></i>End Date (Optional)
                        </label>
                        <input type="date" 
                               name="end_date" 
                               id="end_date" 
                               class="form-control"
                               :class="{ 'is-invalid': endDateError }"
                               x-model="endDate"
                               :min="startDate || todayString"
                               :disabled="isSingleDay"
                               :style="{ opacity: isSingleDay ? '0.5' : '1' }"
                               @change="validateDates()">
                        <div x-show="endDateError" class="invalid-feedback" x-text="endDateError"></div>
                        <div class="form-text">Leave empty for single-day vacation.</div>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" 
                           type="checkbox" 
                           id="singleDay" 
                           x-model="isSingleDay"
                           @change="handleSingleDayToggle()">
                    <label class="form-check-label" for="singleDay">
                        <i class="fas fa-calendar-day me-2"></i>Single day vacation
                    </label>
                </div>
            </div>

            <!-- Vacation Summary -->
            <div x-show="startDate" x-transition class="alert alert-info">
                <h6><i class="fas fa-calendar-check me-2"></i>Vacation Summary</h6>
                <div><strong>Start:</strong> <span x-text="formatDate(startDate)"></span></div>
                <div x-show="endDate && !isSingleDay">
                    <strong>End:</strong> <span x-text="formatDate(endDate)"></span>
                </div>
                <div><strong>Duration:</strong> <span x-text="vacationDuration"></span></div>
                <div x-show="isSingleDay" class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>Single day vacation
                </div>
            </div>

            <div class="d-flex justify-content-end gap-2 mt-4 p-3 bg-light rounded">
                <button type="button" 
                        class="btn btn-outline-secondary btn-lg"
                        @click="closeForm()">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="submit" 
                        class="btn btn-success btn-lg"
                        :disabled="!isFormValid || isSubmitting"
                        style="min-width: 160px; opacity: 1 !important;">
                    <i class="fas fa-plus me-1"></i>
                    Add Vacation
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Alpine.js component for the vacation form partial
document.addEventListener('alpine:init', () => {
    Alpine.data('addVacationModal', () => ({
        startDate: '',
        endDate: '',
        isSingleDay: false,
        isSubmitting: false,
        errorMessage: '',
        startDateError: '',
        endDateError: '',
        
        init() {
            // Initialize form state
            console.log('Alpine.js addVacationModal initialized');
            this.validateDates();
        },
        
        get todayString() {
            return new Date().toISOString().split('T')[0];
        },
        
        get isFormValid() {
            // More explicit validation logic
            const hasStartDate = this.startDate && this.startDate.trim() !== '';
            const noStartDateError = !this.startDateError || this.startDateError === '';
            const noEndDateError = !this.endDateError || this.endDateError === '';
            const noGeneralError = !this.errorMessage || this.errorMessage === '';
            
            return hasStartDate && noStartDateError && noEndDateError && noGeneralError;
        },
        
        get vacationDuration() {
            if (!this.startDate) return '';
            
            if (this.isSingleDay || !this.endDate) {
                return '1 day';
            }
            
            const start = new Date(this.startDate);
            const end = new Date(this.endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            return `${diffDays} day${diffDays > 1 ? 's' : ''}`;
        },
        
        formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        },
        
        validateDates() {
            this.errorMessage = '';
            this.startDateError = '';
            this.endDateError = '';
            
            // Validate start date
            if (this.startDate && this.startDate < this.todayString) {
                this.startDateError = 'Start date cannot be in the past';
                return;
            }
            
            // Validate end date
            if (this.endDate) {
                if (this.endDate < this.todayString) {
                    this.endDateError = 'End date cannot be in the past';
                    return;
                }
                
                if (this.startDate && this.endDate < this.startDate) {
                    this.endDateError = 'End date cannot be before start date';
                    return;
                }
            }
        },
        
        handleSingleDayToggle() {
            if (this.isSingleDay) {
                this.endDate = '';
                this.endDateError = '';
            }
            this.validateDates();
        },
        
        handleSubmit(event) {
            // Validate before submission
            this.validateDates();
            
            if (!this.isFormValid) {
                event.preventDefault();
                if (!this.errorMessage && !this.startDateError && !this.endDateError) {
                    this.errorMessage = 'Please fill in all required fields correctly';
                }
                return false;
            }
            
            this.isSubmitting = true;
            return true;
        },
        
        closeForm() {
            document.getElementById('vacation-form-container').innerHTML = '';
        }
    }));
});

// Handle form errors from HTMX
function handleFormError(event) {
    let errorMessage = 'An error occurred. Please try again.';
    
    if (event.detail.xhr && event.detail.xhr.responseText) {
        try {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = event.detail.xhr.responseText;
            const alertDiv = tempDiv.querySelector('.alert');
            
            if (alertDiv) {
                const textContent = alertDiv.textContent || alertDiv.innerText;
                if (textContent) {
                    errorMessage = textContent.replace(/^\s*\S+\s*/, '').trim();
                }
            }
        } catch (e) {
            console.log('Could not parse error response:', e);
        }
    }
    
    // Find the Alpine component and set the error
    const formContainer = document.querySelector('[x-data*="addVacationModal"]');
    if (formContainer && formContainer._x_dataStack) {
        formContainer._x_dataStack[0].errorMessage = errorMessage;
        formContainer._x_dataStack[0].isSubmitting = false;
    }
}
</script>
