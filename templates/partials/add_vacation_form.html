<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-plus me-2"></i>Add Vacation Period</h5>
        <button type="button" class="btn-close" 
                onclick="document.getElementById('vacation-form-container').innerHTML = ''"
                aria-label="Close"></button>
    </div>
    <div class="card-body">
        <form id="vacation-form"
              hx-post="{{ url_for('add_vacation') }}"
              hx-target="#vacation-table"
              hx-swap="innerHTML"
              hx-on::after-request="if(event.detail.successful) { document.getElementById('vacation-form-container').innerHTML = ''; showSuccessMessage('Vacation period added successfully!'); }"
              hx-on::response-error="handleFormError(event)">
            
            <!-- Error message container -->
            <div id="form-error-container"></div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="start_date" class="form-label">
                            <i class="fas fa-calendar-alt me-2"></i>Start Date
                        </label>
                        <input type="date" name="start_date" id="start_date" class="form-control" required>
                        <div class="form-text">The first day of the vacation period (today or future).</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="end_date" class="form-label">
                            <i class="fas fa-calendar-check me-2"></i>End Date (Optional)
                        </label>
                        <input type="date" name="end_date" id="end_date" class="form-control">
                        <div class="form-text">Leave empty for single-day vacation.</div>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="singleDay" onchange="toggleSingleDay()">
                    <label class="form-check-label" for="singleDay">
                        <i class="fas fa-calendar-day me-2"></i>Single day vacation
                    </label>
                </div>
            </div>

            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-outline-secondary"
                        onclick="document.getElementById('vacation-form-container').innerHTML = ''">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-success" onclick="validateAndSubmit()">
                    <i class="fas fa-plus me-1"></i>Add Vacation
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Validate and submit - only trigger HTMX request if validation passes
function validateAndSubmit() {
    const today = new Date().toISOString().split('T')[0];
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    const startDate = startDateInput.value;
    const endDate = endDateInput.value;
    
    // Clear any previous error messages
    const errorContainer = document.getElementById('form-error-container');
    if (errorContainer) {
        errorContainer.innerHTML = '';
    }
    
    // Validate start date
    if (!startDate) {
        showFormError('Start date is required.');
        return; // Don't submit
    }
    
    if (startDate < today) {
        showFormError('Start date cannot be in the past. Please select today or a future date.');
        return; // Don't submit
    }
    
    // Validate end date if provided
    if (endDate) {
        if (endDate < today) {
            showFormError('End date cannot be in the past. Please select today or a future date.');
            return; // Don't submit
        }
        
        if (endDate < startDate) {
            showFormError('End date cannot be before start date.');
            return; // Don't submit
        }
    }
    
    // Check for overlapping vacations (client-side check)
    if (checkForOverlaps(startDate, endDate || startDate)) {
        return; // Don't submit if overlaps found
    }
    
    // All validation passed - trigger HTMX request manually
    const form = document.getElementById('vacation-form');
    htmx.trigger(form, 'submit');
}

// Check for overlapping vacations on the client side
function checkForOverlaps(newStartDate, newEndDate) {
    // Get existing vacation dates from the vacation table
    const vacationRows = document.querySelectorAll('#vacation-table tbody tr');
    const existingVacations = [];
    
    vacationRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 2) {
            const dateText = cells[1].textContent.trim();
            
            // Parse date range (could be "2025-01-01" or "2025-01-01 - 2025-01-05")
            if (dateText.includes(' - ')) {
                const [start, end] = dateText.split(' - ');
                existingVacations.push({
                    start: start.trim(),
                    end: end.trim()
                });
            } else {
                // Single day vacation
                existingVacations.push({
                    start: dateText,
                    end: dateText
                });
            }
        }
    });
    
    // Check for exact duplicates
    for (const vacation of existingVacations) {
        if (vacation.start === newStartDate && vacation.end === newEndDate) {
            if (newStartDate === newEndDate) {
                showFormError(`You already have a vacation on ${newStartDate}`);
            } else {
                showFormError(`You already have a vacation from ${newStartDate} to ${newEndDate}`);
            }
            return true;
        }
    }
    
    // Check for overlaps
    for (const vacation of existingVacations) {
        // Two date ranges overlap if: start1 <= end2 AND start2 <= end1
        if (newStartDate <= vacation.end && vacation.start <= newEndDate) {
            let overlapMessage;
            if (vacation.start === vacation.end) {
                overlapMessage = `This vacation overlaps with your existing vacation: ${vacation.start}`;
            } else {
                overlapMessage = `This vacation overlaps with your existing vacation: ${vacation.start} to ${vacation.end}`;
            }
            showFormError(overlapMessage);
            return true;
        }
    }
    
    return false; // No overlaps found
}

// Validate before HTMX request to prevent server requests with invalid data
function validateBeforeHTMXRequest(event) {
    const today = new Date().toISOString().split('T')[0];
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    const startDate = startDateInput.value;
    const endDate = endDateInput.value;
    
    // Clear any previous error messages
    const errorContainer = document.getElementById('form-error-container');
    if (errorContainer) {
        errorContainer.innerHTML = '';
    }
    
    // Validate start date
    if (!startDate) {
        showFormError('Start date is required.');
        event.preventDefault(); // Prevent HTMX request
        return false;
    }
    
    if (startDate < today) {
        showFormError('Start date cannot be in the past. Please select today or a future date.');
        event.preventDefault(); // Prevent HTMX request
        return false;
    }
    
    // Validate end date if provided
    if (endDate) {
        if (endDate < today) {
            showFormError('End date cannot be in the past. Please select today or a future date.');
            event.preventDefault(); // Prevent HTMX request
            return false;
        }
        
        if (endDate < startDate) {
            showFormError('End date cannot be before start date.');
            event.preventDefault(); // Prevent HTMX request
            return false;
        }
    }
    
    // All validation passed, allow HTMX request
    return true;
}

// Validate form before submission to prevent server requests with invalid data (fallback for non-HTMX)
function validateFormBeforeSubmit(event) {
    const today = new Date().toISOString().split('T')[0];
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    const startDate = startDateInput.value;
    const endDate = endDateInput.value;
    
    // Clear any previous error messages
    const errorContainer = document.getElementById('form-error-container');
    if (errorContainer) {
        errorContainer.innerHTML = '';
    }
    
    // Validate start date
    if (!startDate) {
        showFormError('Start date is required.');
        return false; // Prevent form submission
    }
    
    if (startDate < today) {
        showFormError('Start date cannot be in the past. Please select today or a future date.');
        return false; // Prevent form submission
    }
    
    // Validate end date if provided
    if (endDate) {
        if (endDate < today) {
            showFormError('End date cannot be in the past. Please select today or a future date.');
            return false; // Prevent form submission
        }
        
        if (endDate < startDate) {
            showFormError('End date cannot be before start date.');
            return false; // Prevent form submission
        }
    }
    
    // All validation passed, allow form submission
    return true;
}

// Handle form-specific errors
function handleFormError(event) {
    let errorMessage = 'An error occurred. Please try again.';
    
    // Try to extract the actual error message from the server response
    if (event.detail.xhr && event.detail.xhr.responseText) {
        try {
            // Check if the response contains an alert div with error message
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = event.detail.xhr.responseText;
            const alertDiv = tempDiv.querySelector('.alert');
            
            if (alertDiv) {
                // Extract text content, removing HTML tags and icons
                const textContent = alertDiv.textContent || alertDiv.innerText;
                if (textContent) {
                    errorMessage = textContent.replace(/^\s*\S+\s*/, '').trim(); // Remove icon text
                }
            }
        } catch (e) {
            console.log('Could not parse error response:', e);
        }
    }
    
    // Show error in the form
    showFormError(errorMessage);
}

// Function to show errors within the form
function showFormError(message) {
    const errorContainer = document.getElementById('form-error-container');
    if (errorContainer) {
        const alertHtml = `
            <div class="alert alert-danger alert-dismissible fade show mb-3" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        errorContainer.innerHTML = alertHtml;
        
        // Auto-dismiss after 7 seconds
        setTimeout(() => {
            const alert = errorContainer.querySelector('.alert');
            if (alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 7000);
    }
}

function toggleSingleDay() {
    const singleDayCheckbox = document.getElementById('singleDay');
    const endDateInput = document.getElementById('end_date');
    
    if (singleDayCheckbox.checked) {
        endDateInput.disabled = true;
        endDateInput.value = '';
        endDateInput.style.opacity = '0.5';
    } else {
        endDateInput.disabled = false;
        endDateInput.style.opacity = '1';
    }
}

// Set minimum date to today and add validation
// Run immediately since this is loaded dynamically via HTMX
(function() {
    const today = new Date().toISOString().split('T')[0];
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    if (startDateInput) {
        // Set minimum date to today (no past dates allowed)
        startDateInput.min = today;
        
        // Update end date minimum when start date changes
        startDateInput.addEventListener('change', function() {
            const selectedStartDate = this.value;
            
            // Clear any previous error messages
            const errorContainer = document.getElementById('form-error-container');
            if (errorContainer) {
                errorContainer.innerHTML = '';
            }
            
            // Validate start date is not in the past (backup validation)
            if (selectedStartDate < today) {
                this.value = today;
                showFormError('Start date cannot be in the past. Setting to today.');
                return;
            }
            
            // Update end date minimum to match start date
            endDateInput.min = selectedStartDate;
            
            // If end date is before start date, clear it
            if (endDateInput.value && endDateInput.value < selectedStartDate) {
                endDateInput.value = '';
                showFormError('End date cleared because it was before the new start date.');
            }
        });
    }
    
    if (endDateInput) {
        endDateInput.min = today;
        
        // Validate end date when changed
        endDateInput.addEventListener('change', function() {
            const startDate = startDateInput.value;
            const endDate = this.value;
            
            // Clear any previous error messages
            const errorContainer = document.getElementById('form-error-container');
            if (errorContainer) {
                errorContainer.innerHTML = '';
            }
            
            if (startDate && endDate && endDate < startDate) {
                this.value = '';
                showFormError('End date cannot be before start date.');
            }
        });
    }
})();
</script>
