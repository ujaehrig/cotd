{% extends "base.html" %}

{% block title %}My Vacations - Vacation Management{% endblock %}

{% block head %}
{{ super() }}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
{% endblock %}

{% block content %}
<div x-data="myVacations()">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-umbrella-beach me-2"></i>My Vacations</h2>
        <button class="btn btn-success" 
                :disabled="isLoading"
                hx-get="{{ url_for('add_vacation') }}"
                hx-target="#vacation-form-container"
                hx-swap="innerHTML"
                @click="isLoading = true"
                @htmx:after-request="isLoading = false">
            <span x-show="!isLoading">
                <i class="fas fa-plus me-1"></i>Add Vacation
            </span>
            <span x-show="isLoading">
                <i class="fas fa-spinner fa-spin me-1"></i>Loading...
            </span>
        </button>
    </div>

    <!-- Success/Error Messages Container -->
    <div id="flash-messages"></div>

    <!-- Form container for HTMX -->
    <div id="vacation-form-container" class="mb-4"></div>

    <div class="card">
        <div class="card-body">
            <div id="vacation-table">
                {% include 'partials/vacation_table.html' %}
            </div>
        </div>
    </div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-info-circle me-2"></i>Vacation Management</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        You can add vacation periods to exclude yourself from being selected as "Catcher of the Day"
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Single-day vacations are useful for sick days or personal days
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Multi-day vacations are for longer periods like holidays
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        You can only view and manage your own vacation periods
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Success notification -->
    <div x-show="showSuccessMessage" 
         x-transition
         class="position-fixed top-0 end-0 p-3" 
         style="z-index: 1050;">
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <span x-text="successMessage"></span>
            <button type="button" class="btn-close" @click="hideSuccessMessage()"></button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('myVacations', () => ({
        isLoading: false,
        showSuccessMessage: false,
        successMessage: '',
        
        init() {
            // Listen for HTMX events
            document.body.addEventListener('htmx:beforeRequest', () => {
                this.isLoading = true;
                // Clear any existing flash messages
                document.getElementById('flash-messages').innerHTML = '';
            });
            
            document.body.addEventListener('htmx:afterRequest', () => {
                this.isLoading = false;
            });
            
            document.body.addEventListener('htmx:responseError', (event) => {
                this.handleError(event);
            });
            
            // Listen for custom vacation events
            document.body.addEventListener('vacationAdded', () => {
                this.showSuccess('Vacation added successfully!');
                // Clear the form
                document.getElementById('vacation-form-container').innerHTML = '';
            });
            
            document.body.addEventListener('vacationDeleted', () => {
                this.showSuccess('Vacation deleted successfully!');
            });
        },
        
        showSuccess(message) {
            this.successMessage = message;
            this.showSuccessMessage = true;
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                this.hideSuccessMessage();
            }, 3000);
        },
        
        hideSuccessMessage() {
            this.showSuccessMessage = false;
        },
        
        handleError(event) {
            let errorMessage = 'An error occurred. Please try again.';
            
            // Try to extract the actual error message from the server response
            if (event.detail.xhr && event.detail.xhr.responseText) {
                try {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = event.detail.xhr.responseText;
                    const alertDiv = tempDiv.querySelector('.alert');
                    
                    if (alertDiv) {
                        const textContent = alertDiv.textContent || alertDiv.innerText;
                        if (textContent) {
                            errorMessage = textContent.replace(/^\s*\S+\s*/, '').trim();
                        }
                    }
                } catch (e) {
                    console.log('Could not parse error response:', e);
                }
            }
            
            this.showError(errorMessage);
        },
        
        showError(message) {
            const flashContainer = document.getElementById('flash-messages');
            flashContainer.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Auto-dismiss after 7 seconds
            setTimeout(() => {
                const alert = flashContainer.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 7000);
        }
    }));
});
</script>
{% endblock %}
